import PouchDB from 'pouchdb';
import { Model } from 'uki';

var appList = {
	"data-binder": {"name":"data-binder","description":"A Mure app that is responsible for (re)binding data to graphics","author":"Alex Bigelow","icon":"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIxLjEuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe29wYWNpdHk6MC42O2ZpbGw6I0U2QUIwMjt9Cgkuc3Qxe29wYWNpdHk6MC4zO2ZpbGw6I0U2QUIwMjt9Cgkuc3Qye29wYWNpdHk6MC42O2ZpbGw6Izc1NzBCMzt9Cgkuc3Qze2ZpbGw6Izc1NzBCMzt9Cgkuc3Q0e29wYWNpdHk6MC4zO2ZpbGw6Izc1NzBCMzt9Cgkuc3Q1e2ZpbGw6I0U2QUIwMjt9Cjwvc3R5bGU+CjxnPgoJPHBhdGggY2xhc3M9InN0MCIgZD0iTTExOS43LDI2Ny43di0yMy40YzU5LjYsMCw3Ny4zLTE5LjcsODMuMi0yNi4xYzE0LjEtMTUuNywxOS0zNy40LDI0LjItNjAuNGM1LjQtMjQsMTEtNDguOSwyNy45LTY4LjMKCQlDMjc0LjEsNjcuNiwzMDQuNiw1NywzNDguMyw1N3YyMy40Yy0zNi41LDAtNjEuMyw4LTc1LjgsMjQuNWMtMTMsMTQuOS0xNy43LDM1LjgtMjIuNyw1OGMtNS42LDI0LjktMTEuNCw1MC42LTI5LjYsNzAuOQoJCUMxOTkuNywyNTYuNiwxNjYuOCwyNjcuNywxMTkuNywyNjcuN3oiLz4KCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0xMTkuNyw0NTV2LTIzLjRjMzQuNCwwLDk0LjMtNDAuMiwxNjQuNC0xMTAuM2wxNi42LDE2LjZDMjQ3LjEsMzkxLjMsMTcyLjQsNDU1LDExOS43LDQ1NXoiLz4KCTxwYXRoIGNsYXNzPSJzdDIiIGQ9Ik03LjUsMjk5LjVjMzIuNy0yNi43LDU2LjYtNDcuMiw1Ni42LTYzLjhjMC0xMS03LTE2LjItMTcuOC0xNi4yYy05LjEsMC0xNi4yLDUuOC0yMi44LDExLjZMNiwyMTMuMwoJCWMxMy4zLTEzLjUsMjUuNy0xOS43LDQ1LTE5LjdjMjYuMywwLDQ0LjcsMTUuOSw0NC43LDQwLjJjMCwxOS43LTIwLjUsNDEuNC00MC42LDU4LjRjNi44LTAuOCwxNi0xLjUsMjItMS41aDI0Ljd2MjcuOEg3LjVWMjk5LjV6IgoJCS8+Cgk8cGF0aCBjbGFzcz0ic3QzIiBkPSJNOC4yLDEwMy45SDM5VjM5LjNIMTMuNFYxOC41YzE1LTIuOCwyNC44LTYuMywzNC43LTEyLjJoMjQuOHY5Ny43aDI2Ljh2MjcuMkg4LjJWMTAzLjl6Ii8+Cgk8cGF0aCBjbGFzcz0ic3Q0IiBkPSJNNi41LDQ4OC43bDE0LjgtMjAuNWM4LDYuOCwxOC4yLDExLjQsMjcuMywxMS40YzExLjgsMCwyMC4xLTMuOCwyMC4xLTExLjRjMC05LjEtNi42LTE0LjQtMzMuNC0xNC40VjQzMQoJCWMyMS42LDAsMjkuNi01LjMsMjkuNi0xMy43YzAtNy4yLTUuNy0xMS0xNS4yLTExYy04LjcsMC0xNS42LDMuNC0yMy45LDkuOUw5LjUsMzk2LjRjMTIuMy05LjksMjYuMi0xNS42LDQxLjgtMTUuNgoJCWMyNy43LDAsNDYuMywxMi4xLDQ2LjMsMzRjMCwxMS42LTcuOCwyMC4zLTIyLDI2djAuOGMxNC44LDQuMiwyNS44LDEzLjcsMjUuOCwyOC44YzAsMjIuOC0yMy4zLDM1LjMtNDkuMywzNS4zCgkJQzMxLjUsNTA1LjgsMTYsNDk5LjMsNi41LDQ4OC43eiIvPgoJPHJlY3QgeD0iMzA1LjQiIHk9IjE5MS42IiBjbGFzcz0ic3Q0IiB3aWR0aD0iMTI0LjkiIGhlaWdodD0iMTI0LjkiLz4KCTxjaXJjbGUgY2xhc3M9InN0MiIgY3g9IjQzNy43IiBjeT0iNzQuNSIgcj0iNjguMyIvPgoJPHBvbHlnb24gY2xhc3M9InN0MyIgcG9pbnRzPSI0MjcuMSwzNjkuMiAzNDguMyw1MDUuOCA1MDYsNTA1LjggCSIvPgoJPHBhdGggY2xhc3M9InN0NSIgZD0iTTM1My45LDQ0OS4yYy0zNC42LDAtNjUtNC41LTkwLjMtMTMuM2MtMjMuOC04LjMtNDMuOS0yMC43LTU5LjgtMzYuOGMtNTMtNTMuNy01MS44LTE0MC01MC45LTIwOS4zCgkJYzAuNi00NC44LDEuMi04Ny4yLTE0LTEwMi41Yy00LjYtNC43LTEwLjctNi44LTE5LjItNi44VjU3YzE0LjgsMCwyNi45LDQuNiwzNS45LDEzLjhjMjIsMjIuMywyMS40LDY3LjMsMjAuNywxMTkuMwoJCWMtMC45LDY4LjMtMiwxNDUuNyw0NC4yLDE5Mi41YzI4LjcsMjkuMSw3Mi4zLDQzLjIsMTMzLjUsNDMuMlY0NDkuMnoiLz4KPC9nPgo8L3N2Zz4K"}
};

class Mure extends Model {
  constructor () {
    super();
    this.appList = appList;
    // Check if we're even being used in the browser (mostly useful for getting
    // access to the applist in all-apps-dev-server.js)
    if (typeof document === 'undefined' || typeof window === undefined) {
      return;
    }

    // Funky stuff to figure out if we're debugging (if that's the case, we want to use
    // localhost instead of the github link for all links)
    let windowTitle = document.getElementsByTagName('title')[0];
    windowTitle = windowTitle ? windowTitle.textContent : '';
    this.debugMode = window.location.hostname === 'localhost' && windowTitle.startsWith('Mure');

    // Figure out which app we are (or null if the mure library is being used somewhere else)
    this.currentApp = window.location.pathname.replace(/\//g, '');
    if (!this.appList[this.currentApp]) {
      this.currentApp = null;
    }

    // Create / load the local database of files
    this.lastFile = null;
    this.db = this.getOrInitDb();

    this.loadUserLibraries = false;
    this.runUserScripts = false;

    // default error handling (apps can listen for / display error messages in addition to this):
    this.on('error', errorMessage => { console.warn(errorMessage); });
    this.catchDbError = errorObj => { this.trigger('error', 'Unexpected error reading PouchDB:\n' + errorObj.stack); };

    // in the absence of a custom dialogs, just use window.prompt:
    this.prompt = window.prompt;
    this.confirm = window.confirm;
  }
  getOrInitDb () {
    let db = new PouchDB('mure');
    db.get('userPrefs').then(prefs => {
      this.lastFile = prefs.currentFile;
    }).catch(errorObj => {
      if (errorObj.message === 'missing') {
        return db.put({
          _id: 'userPrefs',
          currentFile: null
        });
      } else {
        this.catchDbError(errorObj);
      }
    });
    db.changes({
      since: 'now',
      live: true,
      include_docs: true
    }).on('change', change => {
      if (change.id === 'userPrefs') {
        if (this.lastFile !== change.doc.currentFile) {
          // Different filename... a new one was opened, or the current file was deleted
          this.lastFile = change.doc.currentFile;
          // This will have changed the current file list
          this.getFileList().then(fileList => {
            this.trigger('fileListChange', fileList);
          });
        }
        // Whether we have a new file, or the current one was updated, fire a fileChange event
        this.getFile(change.doc.currentFile).then(fileBlob => {
          this.trigger('fileChange', fileBlob);
        });
      } else if (change.deleted && change.id !== this.lastFile) {
        // If a file is deleted that wasn't opened, it won't ever cause a change
        // to userPrefs. So we need to fire fileListChange immediately.
        this.getFileList().then(fileList => {
          this.trigger('fileListChange', fileList);
        });
      }
    }).on('error', errorObj => {
      this.catchDbError(errorObj);
    });
    return db;
  }
  setCurrentFile (filename) {
    return this.db.get('userPrefs').then(prefs => {
      prefs.currentFile = filename;
      return this.db.put(prefs);
    }).catch(this.catchDbError);
  }
  getCurrentFilename () {
    return this.db.get('userPrefs').then(prefs => {
      return prefs.currentFile;
    });
  }
  getFile (filename) {
    if (filename) {
      return this.db.getAttachment(filename, filename);
    } else {
      return Promise.resolve(null);
    }
  }
  signalSvgLoaded (loadUserLibrariesFunc, runUserScriptsFunc) {
    // Only load the SVG's linked libraries + embedded scripts if we've been told to
    let callback = this.runUserScripts ? runUserScriptsFunc : () => {};
    if (this.loadUserLibraries) {
      loadUserLibrariesFunc(callback);
    }
    this.trigger('svgLoaded');
  }
  on (eventName, callback) {
    if (!Mure.VALID_EVENTS[eventName]) {
      throw new Error('Unknown event name: ' + eventName);
    } else {
      super.on(eventName, callback);
    }
  }
  customizeConfirmDialog (showDialogFunction) {
    this.confirm = showDialogFunction;
  }
  customizePromptDialog (showDialogFunction) {
    this.prompt = showDialogFunction;
  }
  openApp (appName) {
    window.open('/' + appName, '_blank');
  }
  getSvgBlob (filename) {
    return this.db.getAttachment(filename, filename)
      .catch(this.catchDbError);
  }
  saveSvgBlob (filename, blob) {
    let dbEntry = {
      _id: filename,
      _attachments: {}
    };
    dbEntry._attachments[filename] = {
      content_type: blob.type,
      data: blob
    };
    return this.db.get(filename).then(existingDoc => {
      // the file exists... overwrite the document
      dbEntry._rev = existingDoc._rev;
      return this.db.put(dbEntry);
    }).catch(errorObj => {
      if (errorObj.message === 'missing') {
        // the file doesn't exist yet...
        return this.db.put(dbEntry);
      } else {
        this.catchDbError(errorObj);
      }
    });
  }
  getFileList () {
    return this.db.allDocs()
      .then(response => {
        let result = [];
        response.rows.forEach(d => {
          if (d.id !== 'userPrefs') {
            result.push(d.id);
          }
        });
        return result;
      }).catch(this.catchDbError);
  }
  getFileRevisions () {
    return this.db.allDocs()
      .then(response => {
        let result = {};
        response.rows.forEach(d => {
          if (d.id !== 'userPrefs') {
            result[d.id] = d.value.rev;
          }
        });
        return result;
      }).catch(this.catchDbError);
  }
  uploadSvg (fileObj) {
    let filename = fileObj.name;
    return this.getFileRevisions().then(revisionDict => {
      // Ask multiple times if the user happens to enter another filename that already exists
      while (revisionDict[filename]) {
        let newName = this.prompt.call(window,
          fileObj.name + ' already exists. Pick a new name, or leave it the same to overwrite:',
          fileObj.name);
        if (!newName) {
          return null;
        } else if (newName === filename) {
          return filename;
        } else {
          filename = newName;
        }
      }
      return filename;
    }).then(filename => {
      if (filename) {
        return this.saveSvgBlob(filename, fileObj).then(() => {
          return this.setCurrentFile(filename);
        });
      }
    }).catch(this.catchDbError);
  }
  deleteSvg (filename) {
    if (this.confirm.call(window, 'Are you sure you want to delete ' + filename + '?')) {
      return Promise.all([this.db.get(filename), this.getCurrentFilename()]).then(promiseResults => {
        let existingDoc = promiseResults[0];
        let currentFile = promiseResults[1];
        return this.db.remove(existingDoc._id, existingDoc._rev)
          .then(removeResponse => {
            if (filename === currentFile) {
              this.setCurrentFile(null).catch(this.catchDbError);
            }
            return removeResponse;
          });
      }).catch(this.catchDbError);
    }
  }
  downloadSvg (filename) {
    this.getSvgBlob(filename).then(blob => {
      // create a fake link...
      let a = document.createElement('a');
      a.style = 'display:none';
      let url = window.URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      a.parentNode.removeChild(a);
    }).catch(this.catchDbError);
  }
}

Mure.VALID_EVENTS = {
  fileListChange: true,
  fileChange: true,
  error: true,
  svgLoaded: true
};

let mure = new Mure();

export default mure;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVyZS5lcy5qcyIsInNvdXJjZXMiOlsiLi4vc3JjL211cmUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBvdWNoREIgZnJvbSAncG91Y2hkYic7XG5pbXBvcnQgYXBwTGlzdCBmcm9tICcuL2FwcExpc3QuanNvbic7XG5pbXBvcnQgeyBNb2RlbCB9IGZyb20gJ3VraSc7XG5cbmNsYXNzIE11cmUgZXh0ZW5kcyBNb2RlbCB7XG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYXBwTGlzdCA9IGFwcExpc3Q7XG4gICAgLy8gQ2hlY2sgaWYgd2UncmUgZXZlbiBiZWluZyB1c2VkIGluIHRoZSBicm93c2VyIChtb3N0bHkgdXNlZnVsIGZvciBnZXR0aW5nXG4gICAgLy8gYWNjZXNzIHRvIHRoZSBhcHBsaXN0IGluIGFsbC1hcHBzLWRldi1zZXJ2ZXIuanMpXG4gICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHdpbmRvdyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gRnVua3kgc3R1ZmYgdG8gZmlndXJlIG91dCBpZiB3ZSdyZSBkZWJ1Z2dpbmcgKGlmIHRoYXQncyB0aGUgY2FzZSwgd2Ugd2FudCB0byB1c2VcbiAgICAvLyBsb2NhbGhvc3QgaW5zdGVhZCBvZiB0aGUgZ2l0aHViIGxpbmsgZm9yIGFsbCBsaW5rcylcbiAgICBsZXQgd2luZG93VGl0bGUgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGl0bGUnKVswXTtcbiAgICB3aW5kb3dUaXRsZSA9IHdpbmRvd1RpdGxlID8gd2luZG93VGl0bGUudGV4dENvbnRlbnQgOiAnJztcbiAgICB0aGlzLmRlYnVnTW9kZSA9IHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZSA9PT0gJ2xvY2FsaG9zdCcgJiYgd2luZG93VGl0bGUuc3RhcnRzV2l0aCgnTXVyZScpO1xuXG4gICAgLy8gRmlndXJlIG91dCB3aGljaCBhcHAgd2UgYXJlIChvciBudWxsIGlmIHRoZSBtdXJlIGxpYnJhcnkgaXMgYmVpbmcgdXNlZCBzb21ld2hlcmUgZWxzZSlcbiAgICB0aGlzLmN1cnJlbnRBcHAgPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvXFwvL2csICcnKTtcbiAgICBpZiAoIXRoaXMuYXBwTGlzdFt0aGlzLmN1cnJlbnRBcHBdKSB7XG4gICAgICB0aGlzLmN1cnJlbnRBcHAgPSBudWxsO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSAvIGxvYWQgdGhlIGxvY2FsIGRhdGFiYXNlIG9mIGZpbGVzXG4gICAgdGhpcy5sYXN0RmlsZSA9IG51bGw7XG4gICAgdGhpcy5kYiA9IHRoaXMuZ2V0T3JJbml0RGIoKTtcblxuICAgIHRoaXMubG9hZFVzZXJMaWJyYXJpZXMgPSBmYWxzZTtcbiAgICB0aGlzLnJ1blVzZXJTY3JpcHRzID0gZmFsc2U7XG5cbiAgICAvLyBkZWZhdWx0IGVycm9yIGhhbmRsaW5nIChhcHBzIGNhbiBsaXN0ZW4gZm9yIC8gZGlzcGxheSBlcnJvciBtZXNzYWdlcyBpbiBhZGRpdGlvbiB0byB0aGlzKTpcbiAgICB0aGlzLm9uKCdlcnJvcicsIGVycm9yTWVzc2FnZSA9PiB7IGNvbnNvbGUud2FybihlcnJvck1lc3NhZ2UpOyB9KTtcbiAgICB0aGlzLmNhdGNoRGJFcnJvciA9IGVycm9yT2JqID0+IHsgdGhpcy50cmlnZ2VyKCdlcnJvcicsICdVbmV4cGVjdGVkIGVycm9yIHJlYWRpbmcgUG91Y2hEQjpcXG4nICsgZXJyb3JPYmouc3RhY2spOyB9O1xuXG4gICAgLy8gaW4gdGhlIGFic2VuY2Ugb2YgYSBjdXN0b20gZGlhbG9ncywganVzdCB1c2Ugd2luZG93LnByb21wdDpcbiAgICB0aGlzLnByb21wdCA9IHdpbmRvdy5wcm9tcHQ7XG4gICAgdGhpcy5jb25maXJtID0gd2luZG93LmNvbmZpcm07XG4gIH1cbiAgZ2V0T3JJbml0RGIgKCkge1xuICAgIGxldCBkYiA9IG5ldyBQb3VjaERCKCdtdXJlJyk7XG4gICAgZGIuZ2V0KCd1c2VyUHJlZnMnKS50aGVuKHByZWZzID0+IHtcbiAgICAgIHRoaXMubGFzdEZpbGUgPSBwcmVmcy5jdXJyZW50RmlsZTtcbiAgICB9KS5jYXRjaChlcnJvck9iaiA9PiB7XG4gICAgICBpZiAoZXJyb3JPYmoubWVzc2FnZSA9PT0gJ21pc3NpbmcnKSB7XG4gICAgICAgIHJldHVybiBkYi5wdXQoe1xuICAgICAgICAgIF9pZDogJ3VzZXJQcmVmcycsXG4gICAgICAgICAgY3VycmVudEZpbGU6IG51bGxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNhdGNoRGJFcnJvcihlcnJvck9iaik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgZGIuY2hhbmdlcyh7XG4gICAgICBzaW5jZTogJ25vdycsXG4gICAgICBsaXZlOiB0cnVlLFxuICAgICAgaW5jbHVkZV9kb2NzOiB0cnVlXG4gICAgfSkub24oJ2NoYW5nZScsIGNoYW5nZSA9PiB7XG4gICAgICBpZiAoY2hhbmdlLmlkID09PSAndXNlclByZWZzJykge1xuICAgICAgICBpZiAodGhpcy5sYXN0RmlsZSAhPT0gY2hhbmdlLmRvYy5jdXJyZW50RmlsZSkge1xuICAgICAgICAgIC8vIERpZmZlcmVudCBmaWxlbmFtZS4uLiBhIG5ldyBvbmUgd2FzIG9wZW5lZCwgb3IgdGhlIGN1cnJlbnQgZmlsZSB3YXMgZGVsZXRlZFxuICAgICAgICAgIHRoaXMubGFzdEZpbGUgPSBjaGFuZ2UuZG9jLmN1cnJlbnRGaWxlO1xuICAgICAgICAgIC8vIFRoaXMgd2lsbCBoYXZlIGNoYW5nZWQgdGhlIGN1cnJlbnQgZmlsZSBsaXN0XG4gICAgICAgICAgdGhpcy5nZXRGaWxlTGlzdCgpLnRoZW4oZmlsZUxpc3QgPT4ge1xuICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdmaWxlTGlzdENoYW5nZScsIGZpbGVMaXN0KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICAvLyBXaGV0aGVyIHdlIGhhdmUgYSBuZXcgZmlsZSwgb3IgdGhlIGN1cnJlbnQgb25lIHdhcyB1cGRhdGVkLCBmaXJlIGEgZmlsZUNoYW5nZSBldmVudFxuICAgICAgICB0aGlzLmdldEZpbGUoY2hhbmdlLmRvYy5jdXJyZW50RmlsZSkudGhlbihmaWxlQmxvYiA9PiB7XG4gICAgICAgICAgdGhpcy50cmlnZ2VyKCdmaWxlQ2hhbmdlJywgZmlsZUJsb2IpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoY2hhbmdlLmRlbGV0ZWQgJiYgY2hhbmdlLmlkICE9PSB0aGlzLmxhc3RGaWxlKSB7XG4gICAgICAgIC8vIElmIGEgZmlsZSBpcyBkZWxldGVkIHRoYXQgd2Fzbid0IG9wZW5lZCwgaXQgd29uJ3QgZXZlciBjYXVzZSBhIGNoYW5nZVxuICAgICAgICAvLyB0byB1c2VyUHJlZnMuIFNvIHdlIG5lZWQgdG8gZmlyZSBmaWxlTGlzdENoYW5nZSBpbW1lZGlhdGVseS5cbiAgICAgICAgdGhpcy5nZXRGaWxlTGlzdCgpLnRoZW4oZmlsZUxpc3QgPT4ge1xuICAgICAgICAgIHRoaXMudHJpZ2dlcignZmlsZUxpc3RDaGFuZ2UnLCBmaWxlTGlzdCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pLm9uKCdlcnJvcicsIGVycm9yT2JqID0+IHtcbiAgICAgIHRoaXMuY2F0Y2hEYkVycm9yKGVycm9yT2JqKTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGI7XG4gIH1cbiAgc2V0Q3VycmVudEZpbGUgKGZpbGVuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuZGIuZ2V0KCd1c2VyUHJlZnMnKS50aGVuKHByZWZzID0+IHtcbiAgICAgIHByZWZzLmN1cnJlbnRGaWxlID0gZmlsZW5hbWU7XG4gICAgICByZXR1cm4gdGhpcy5kYi5wdXQocHJlZnMpO1xuICAgIH0pLmNhdGNoKHRoaXMuY2F0Y2hEYkVycm9yKTtcbiAgfVxuICBnZXRDdXJyZW50RmlsZW5hbWUgKCkge1xuICAgIHJldHVybiB0aGlzLmRiLmdldCgndXNlclByZWZzJykudGhlbihwcmVmcyA9PiB7XG4gICAgICByZXR1cm4gcHJlZnMuY3VycmVudEZpbGU7XG4gICAgfSk7XG4gIH1cbiAgZ2V0RmlsZSAoZmlsZW5hbWUpIHtcbiAgICBpZiAoZmlsZW5hbWUpIHtcbiAgICAgIHJldHVybiB0aGlzLmRiLmdldEF0dGFjaG1lbnQoZmlsZW5hbWUsIGZpbGVuYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9XG4gIH1cbiAgc2lnbmFsU3ZnTG9hZGVkIChsb2FkVXNlckxpYnJhcmllc0Z1bmMsIHJ1blVzZXJTY3JpcHRzRnVuYykge1xuICAgIC8vIE9ubHkgbG9hZCB0aGUgU1ZHJ3MgbGlua2VkIGxpYnJhcmllcyArIGVtYmVkZGVkIHNjcmlwdHMgaWYgd2UndmUgYmVlbiB0b2xkIHRvXG4gICAgbGV0IGNhbGxiYWNrID0gdGhpcy5ydW5Vc2VyU2NyaXB0cyA/IHJ1blVzZXJTY3JpcHRzRnVuYyA6ICgpID0+IHt9O1xuICAgIGlmICh0aGlzLmxvYWRVc2VyTGlicmFyaWVzKSB7XG4gICAgICBsb2FkVXNlckxpYnJhcmllc0Z1bmMoY2FsbGJhY2spO1xuICAgIH1cbiAgICB0aGlzLnRyaWdnZXIoJ3N2Z0xvYWRlZCcpO1xuICB9XG4gIG9uIChldmVudE5hbWUsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFNdXJlLlZBTElEX0VWRU5UU1tldmVudE5hbWVdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gZXZlbnQgbmFtZTogJyArIGV2ZW50TmFtZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN1cGVyLm9uKGV2ZW50TmFtZSwgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuICBjdXN0b21pemVDb25maXJtRGlhbG9nIChzaG93RGlhbG9nRnVuY3Rpb24pIHtcbiAgICB0aGlzLmNvbmZpcm0gPSBzaG93RGlhbG9nRnVuY3Rpb247XG4gIH1cbiAgY3VzdG9taXplUHJvbXB0RGlhbG9nIChzaG93RGlhbG9nRnVuY3Rpb24pIHtcbiAgICB0aGlzLnByb21wdCA9IHNob3dEaWFsb2dGdW5jdGlvbjtcbiAgfVxuICBvcGVuQXBwIChhcHBOYW1lKSB7XG4gICAgd2luZG93Lm9wZW4oJy8nICsgYXBwTmFtZSwgJ19ibGFuaycpO1xuICB9XG4gIGdldFN2Z0Jsb2IgKGZpbGVuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuZGIuZ2V0QXR0YWNobWVudChmaWxlbmFtZSwgZmlsZW5hbWUpXG4gICAgICAuY2F0Y2godGhpcy5jYXRjaERiRXJyb3IpO1xuICB9XG4gIHNhdmVTdmdCbG9iIChmaWxlbmFtZSwgYmxvYikge1xuICAgIGxldCBkYkVudHJ5ID0ge1xuICAgICAgX2lkOiBmaWxlbmFtZSxcbiAgICAgIF9hdHRhY2htZW50czoge31cbiAgICB9O1xuICAgIGRiRW50cnkuX2F0dGFjaG1lbnRzW2ZpbGVuYW1lXSA9IHtcbiAgICAgIGNvbnRlbnRfdHlwZTogYmxvYi50eXBlLFxuICAgICAgZGF0YTogYmxvYlxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuZGIuZ2V0KGZpbGVuYW1lKS50aGVuKGV4aXN0aW5nRG9jID0+IHtcbiAgICAgIC8vIHRoZSBmaWxlIGV4aXN0cy4uLiBvdmVyd3JpdGUgdGhlIGRvY3VtZW50XG4gICAgICBkYkVudHJ5Ll9yZXYgPSBleGlzdGluZ0RvYy5fcmV2O1xuICAgICAgcmV0dXJuIHRoaXMuZGIucHV0KGRiRW50cnkpO1xuICAgIH0pLmNhdGNoKGVycm9yT2JqID0+IHtcbiAgICAgIGlmIChlcnJvck9iai5tZXNzYWdlID09PSAnbWlzc2luZycpIHtcbiAgICAgICAgLy8gdGhlIGZpbGUgZG9lc24ndCBleGlzdCB5ZXQuLi5cbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucHV0KGRiRW50cnkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jYXRjaERiRXJyb3IoZXJyb3JPYmopO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIGdldEZpbGVMaXN0ICgpIHtcbiAgICByZXR1cm4gdGhpcy5kYi5hbGxEb2NzKClcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IFtdO1xuICAgICAgICByZXNwb25zZS5yb3dzLmZvckVhY2goZCA9PiB7XG4gICAgICAgICAgaWYgKGQuaWQgIT09ICd1c2VyUHJlZnMnKSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaChkLmlkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSkuY2F0Y2godGhpcy5jYXRjaERiRXJyb3IpO1xuICB9XG4gIGdldEZpbGVSZXZpc2lvbnMgKCkge1xuICAgIHJldHVybiB0aGlzLmRiLmFsbERvY3MoKVxuICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0ID0ge307XG4gICAgICAgIHJlc3BvbnNlLnJvd3MuZm9yRWFjaChkID0+IHtcbiAgICAgICAgICBpZiAoZC5pZCAhPT0gJ3VzZXJQcmVmcycpIHtcbiAgICAgICAgICAgIHJlc3VsdFtkLmlkXSA9IGQudmFsdWUucmV2O1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KS5jYXRjaCh0aGlzLmNhdGNoRGJFcnJvcik7XG4gIH1cbiAgdXBsb2FkU3ZnIChmaWxlT2JqKSB7XG4gICAgbGV0IGZpbGVuYW1lID0gZmlsZU9iai5uYW1lO1xuICAgIHJldHVybiB0aGlzLmdldEZpbGVSZXZpc2lvbnMoKS50aGVuKHJldmlzaW9uRGljdCA9PiB7XG4gICAgICAvLyBBc2sgbXVsdGlwbGUgdGltZXMgaWYgdGhlIHVzZXIgaGFwcGVucyB0byBlbnRlciBhbm90aGVyIGZpbGVuYW1lIHRoYXQgYWxyZWFkeSBleGlzdHNcbiAgICAgIHdoaWxlIChyZXZpc2lvbkRpY3RbZmlsZW5hbWVdKSB7XG4gICAgICAgIGxldCBuZXdOYW1lID0gdGhpcy5wcm9tcHQuY2FsbCh3aW5kb3csXG4gICAgICAgICAgZmlsZU9iai5uYW1lICsgJyBhbHJlYWR5IGV4aXN0cy4gUGljayBhIG5ldyBuYW1lLCBvciBsZWF2ZSBpdCB0aGUgc2FtZSB0byBvdmVyd3JpdGU6JyxcbiAgICAgICAgICBmaWxlT2JqLm5hbWUpO1xuICAgICAgICBpZiAoIW5ld05hbWUpIHtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSBlbHNlIGlmIChuZXdOYW1lID09PSBmaWxlbmFtZSkge1xuICAgICAgICAgIHJldHVybiBmaWxlbmFtZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmaWxlbmFtZSA9IG5ld05hbWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBmaWxlbmFtZTtcbiAgICB9KS50aGVuKGZpbGVuYW1lID0+IHtcbiAgICAgIGlmIChmaWxlbmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zYXZlU3ZnQmxvYihmaWxlbmFtZSwgZmlsZU9iaikudGhlbigoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2V0Q3VycmVudEZpbGUoZmlsZW5hbWUpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KS5jYXRjaCh0aGlzLmNhdGNoRGJFcnJvcik7XG4gIH1cbiAgZGVsZXRlU3ZnIChmaWxlbmFtZSkge1xuICAgIGlmICh0aGlzLmNvbmZpcm0uY2FsbCh3aW5kb3csICdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZGVsZXRlICcgKyBmaWxlbmFtZSArICc/JykpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLmFsbChbdGhpcy5kYi5nZXQoZmlsZW5hbWUpLCB0aGlzLmdldEN1cnJlbnRGaWxlbmFtZSgpXSkudGhlbihwcm9taXNlUmVzdWx0cyA9PiB7XG4gICAgICAgIGxldCBleGlzdGluZ0RvYyA9IHByb21pc2VSZXN1bHRzWzBdO1xuICAgICAgICBsZXQgY3VycmVudEZpbGUgPSBwcm9taXNlUmVzdWx0c1sxXTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucmVtb3ZlKGV4aXN0aW5nRG9jLl9pZCwgZXhpc3RpbmdEb2MuX3JldilcbiAgICAgICAgICAudGhlbihyZW1vdmVSZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAoZmlsZW5hbWUgPT09IGN1cnJlbnRGaWxlKSB7XG4gICAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudEZpbGUobnVsbCkuY2F0Y2godGhpcy5jYXRjaERiRXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlbW92ZVJlc3BvbnNlO1xuICAgICAgICAgIH0pO1xuICAgICAgfSkuY2F0Y2godGhpcy5jYXRjaERiRXJyb3IpO1xuICAgIH1cbiAgfVxuICBkb3dubG9hZFN2ZyAoZmlsZW5hbWUpIHtcbiAgICB0aGlzLmdldFN2Z0Jsb2IoZmlsZW5hbWUpLnRoZW4oYmxvYiA9PiB7XG4gICAgICAvLyBjcmVhdGUgYSBmYWtlIGxpbmsuLi5cbiAgICAgIGxldCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xuICAgICAgYS5zdHlsZSA9ICdkaXNwbGF5Om5vbmUnO1xuICAgICAgbGV0IHVybCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuICAgICAgYS5ocmVmID0gdXJsO1xuICAgICAgYS5kb3dubG9hZCA9IGZpbGVuYW1lO1xuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTtcbiAgICAgIGEuY2xpY2soKTtcbiAgICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7XG4gICAgICBhLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYSk7XG4gICAgfSkuY2F0Y2godGhpcy5jYXRjaERiRXJyb3IpO1xuICB9XG59XG5cbk11cmUuVkFMSURfRVZFTlRTID0ge1xuICBmaWxlTGlzdENoYW5nZTogdHJ1ZSxcbiAgZmlsZUNoYW5nZTogdHJ1ZSxcbiAgZXJyb3I6IHRydWUsXG4gIHN2Z0xvYWRlZDogdHJ1ZVxufTtcblxubGV0IG11cmUgPSBuZXcgTXVyZSgpO1xuZXhwb3J0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
