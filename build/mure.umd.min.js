!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("babel-polyfill"),require("d3"),require("datalib"),require("jsonpath"),require("pouchdb"),require("uki")):"function"==typeof define&&define.amd?define(["babel-polyfill","d3","datalib","jsonpath","pouchdb","uki"],t):e.mure=t(null,e.d3,e.datalib,e.jsonpath,e.PouchDB,e.uki)}(this,function(e,t,r,n,i,a){"use strict";r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i;var u={docs:{name:"docs",description:"The core app / landing page for Mure",author:"Alex Bigelow",icon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIxLjAuMiwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe2ZpbGw6I0U2QUIwMjt9Cgkuc3Qxe29wYWNpdHk6MC4zO2ZpbGw6Izc1NzBCMztlbmFibGUtYmFja2dyb3VuZDpuZXcgICAgO30KCS5zdDJ7b3BhY2l0eTowLjQ1O2ZpbGw6I0U2QUIwMjtlbmFibGUtYmFja2dyb3VuZDpuZXcgICAgO30KCS5zdDN7b3BhY2l0eTowLjU1O2ZpbGw6Izc1NzBCMztlbmFibGUtYmFja2dyb3VuZDpuZXcgICAgO30KCS5zdDR7b3BhY2l0eTowLjI7ZmlsbDojRTZBQjAyO2VuYWJsZS1iYWNrZ3JvdW5kOm5ldyAgICA7fQoJLnN0NXtmaWxsOiM3NTcwQjM7fQo8L3N0eWxlPgo8cG9seWdvbiBjbGFzcz0ic3QwIiBwb2ludHM9IjMzOS4zLDQwNy4zIDI1Niw1MDYgMTcyLjcsNDA3LjMgIi8+Cjxwb2x5Z29uIGNsYXNzPSJzdDEiIHBvaW50cz0iMjE0LjEsMzcyLjIgMjk3LjUsMjczLjUgMzgwLjgsMzcyLjIgIi8+Cjxwb2x5Z29uIGNsYXNzPSJzdDIiIHBvaW50cz0iNTA2LDI3My41IDQyMi43LDM3Mi4yIDMzOS4zLDI3My41ICIvPgo8cG9seWdvbiBjbGFzcz0ic3QzIiBwb2ludHM9IjI1NiwyMzguNSAzMzkuMywxMzkuOCA0MjIuNywyMzguNSAiLz4KPHBvbHlnb24gY2xhc3M9InN0MiIgcG9pbnRzPSIyNTYsMjczLjUgMTcyLjcsMzcyLjIgODkuMywyNzMuNSAiLz4KPHBvbHlnb24gY2xhc3M9InN0MyIgcG9pbnRzPSI2LDIzOC41IDg5LjMsMTM5LjggMTcyLjcsMjM4LjUgIi8+Cjxwb2x5Z29uIGNsYXNzPSJzdDQiIHBvaW50cz0iMjk3LjUsMTM5LjggMjE0LjEsMjM4LjUgMTMwLjgsMTM5LjggIi8+Cjxwb2x5Z29uIGNsYXNzPSJzdDUiIHBvaW50cz0iMTcyLjcsMTA0LjcgMjU2LDYgMzM5LjMsMTA0LjcgIi8+Cjwvc3ZnPgo="},"data-binder":{name:"data-binder",description:"A Mure app that is responsible for (re)binding data to graphics",author:"Alex Bigelow",icon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIxLjEuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe29wYWNpdHk6MC42O2ZpbGw6I0U2QUIwMjt9Cgkuc3Qxe29wYWNpdHk6MC4zO2ZpbGw6I0U2QUIwMjt9Cgkuc3Qye29wYWNpdHk6MC42O2ZpbGw6Izc1NzBCMzt9Cgkuc3Qze2ZpbGw6Izc1NzBCMzt9Cgkuc3Q0e29wYWNpdHk6MC4zO2ZpbGw6Izc1NzBCMzt9Cgkuc3Q1e2ZpbGw6I0U2QUIwMjt9Cjwvc3R5bGU+CjxnPgoJPHBhdGggY2xhc3M9InN0MCIgZD0iTTExOS43LDI2Ny43di0yMy40YzU5LjYsMCw3Ny4zLTE5LjcsODMuMi0yNi4xYzE0LjEtMTUuNywxOS0zNy40LDI0LjItNjAuNGM1LjQtMjQsMTEtNDguOSwyNy45LTY4LjMKCQlDMjc0LjEsNjcuNiwzMDQuNiw1NywzNDguMyw1N3YyMy40Yy0zNi41LDAtNjEuMyw4LTc1LjgsMjQuNWMtMTMsMTQuOS0xNy43LDM1LjgtMjIuNyw1OGMtNS42LDI0LjktMTEuNCw1MC42LTI5LjYsNzAuOQoJCUMxOTkuNywyNTYuNiwxNjYuOCwyNjcuNywxMTkuNywyNjcuN3oiLz4KCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0xMTkuNyw0NTV2LTIzLjRjMzQuNCwwLDk0LjMtNDAuMiwxNjQuNC0xMTAuM2wxNi42LDE2LjZDMjQ3LjEsMzkxLjMsMTcyLjQsNDU1LDExOS43LDQ1NXoiLz4KCTxwYXRoIGNsYXNzPSJzdDIiIGQ9Ik03LjUsMjk5LjVjMzIuNy0yNi43LDU2LjYtNDcuMiw1Ni42LTYzLjhjMC0xMS03LTE2LjItMTcuOC0xNi4yYy05LjEsMC0xNi4yLDUuOC0yMi44LDExLjZMNiwyMTMuMwoJCWMxMy4zLTEzLjUsMjUuNy0xOS43LDQ1LTE5LjdjMjYuMywwLDQ0LjcsMTUuOSw0NC43LDQwLjJjMCwxOS43LTIwLjUsNDEuNC00MC42LDU4LjRjNi44LTAuOCwxNi0xLjUsMjItMS41aDI0Ljd2MjcuOEg3LjVWMjk5LjV6IgoJCS8+Cgk8cGF0aCBjbGFzcz0ic3QzIiBkPSJNOC4yLDEwMy45SDM5VjM5LjNIMTMuNFYxOC41YzE1LTIuOCwyNC44LTYuMywzNC43LTEyLjJoMjQuOHY5Ny43aDI2Ljh2MjcuMkg4LjJWMTAzLjl6Ii8+Cgk8cGF0aCBjbGFzcz0ic3Q0IiBkPSJNNi41LDQ4OC43bDE0LjgtMjAuNWM4LDYuOCwxOC4yLDExLjQsMjcuMywxMS40YzExLjgsMCwyMC4xLTMuOCwyMC4xLTExLjRjMC05LjEtNi42LTE0LjQtMzMuNC0xNC40VjQzMQoJCWMyMS42LDAsMjkuNi01LjMsMjkuNi0xMy43YzAtNy4yLTUuNy0xMS0xNS4yLTExYy04LjcsMC0xNS42LDMuNC0yMy45LDkuOUw5LjUsMzk2LjRjMTIuMy05LjksMjYuMi0xNS42LDQxLjgtMTUuNgoJCWMyNy43LDAsNDYuMywxMi4xLDQ2LjMsMzRjMCwxMS42LTcuOCwyMC4zLTIyLDI2djAuOGMxNC44LDQuMiwyNS44LDEzLjcsMjUuOCwyOC44YzAsMjIuOC0yMy4zLDM1LjMtNDkuMywzNS4zCgkJQzMxLjUsNTA1LjgsMTYsNDk5LjMsNi41LDQ4OC43eiIvPgoJPHJlY3QgeD0iMzA1LjQiIHk9IjE5MS42IiBjbGFzcz0ic3Q0IiB3aWR0aD0iMTI0LjkiIGhlaWdodD0iMTI0LjkiLz4KCTxjaXJjbGUgY2xhc3M9InN0MiIgY3g9IjQzNy43IiBjeT0iNzQuNSIgcj0iNjguMyIvPgoJPHBvbHlnb24gY2xhc3M9InN0MyIgcG9pbnRzPSI0MjcuMSwzNjkuMiAzNDguMyw1MDUuOCA1MDYsNTA1LjggCSIvPgoJPHBhdGggY2xhc3M9InN0NSIgZD0iTTM1My45LDQ0OS4yYy0zNC42LDAtNjUtNC41LTkwLjMtMTMuM2MtMjMuOC04LjMtNDMuOS0yMC43LTU5LjgtMzYuOGMtNTMtNTMuNy01MS44LTE0MC01MC45LTIwOS4zCgkJYzAuNi00NC44LDEuMi04Ny4yLTE0LTEwMi41Yy00LjYtNC43LTEwLjctNi44LTE5LjItNi44VjU3YzE0LjgsMCwyNi45LDQuNiwzNS45LDEzLjhjMjIsMjIuMywyMS40LDY3LjMsMjAuNywxMTkuMwoJCWMtMC45LDY4LjMtMiwxNDUuNyw0NC4yLDE5Mi41YzI4LjcsMjkuMSw3Mi4zLDQzLjIsMTMzLjUsNDMuMlY0NDkuMnoiLz4KPC9nPgo8L3N2Zz4K"}},o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=(function(){function e(e){this.value=e}function t(t){function r(i,a){try{var u=t[i](a),o=u.value;o instanceof e?Promise.resolve(o.value).then(function(e){r("next",e)},function(e){r("throw",e)}):n(u.done?"return":"normal",u.value)}catch(e){n("throw",e)}}function n(e,t){switch(e){case"return":i.resolve({value:t,done:!0});break;case"throw":i.reject(t);break;default:i.resolve({value:t,done:!1})}(i=i.next)?r(i.key,i.arg):a=null}var i,a;this._invoke=function(e,t){return new Promise(function(n,u){var o={key:e,arg:t,resolve:n,reject:u,next:null};a?a=a.next=o:(i=a=o,r(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(i,a){try{var u=t[i](a),o=u.value}catch(e){return void r(e)}if(!u.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}return n("next")})}}),c=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},l=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),d=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var u=i.get;if(void 0!==u)return u.call(n)},p=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},g=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},f=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var u,o=e[Symbol.iterator]();!(n=(u=o.next()).done)&&(r.push(u.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(e){function a(){c(this,a);var e=g(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));if(e.appList=u,"undefined"==typeof document||void 0===("undefined"==typeof window?"undefined":o(window)))return g(e);e.NSString="http://mure-apps.github.io",t.namespaces.mure=e.NSString;var r=document.getElementsByTagName("title")[0];return r=r?r.textContent:"",e.debugMode="localhost"===window.location.hostname&&r.startsWith("Mure"),e.currentApp=window.location.pathname.replace(/\//g,""),e.appList[e.currentApp]||(e.currentApp=null),e.lastFile=null,e.db=e.getOrInitDb(),e.on("error",function(e){console.warn(e)}),e.catchDbError=function(t){e.trigger("error","Unexpected error reading PouchDB: "+t.message+"\n"+t.stack)},e.alert=function(e){return new Promise(function(t,r){window.alert(e),t(!0)})},e.confirm=function(e){return new Promise(function(t,r){t(window.confirm(e))})},e.prompt=function(e,t){return new Promise(function(r,n){r(window.prompt(e,t))})},e}return p(a,e),l(a,[{key:"getOrInitDb",value:function(){var e=this,t=new i("mure");return t.get("userPrefs").then(function(t){e.lastFile=t.currentFile}).catch(function(r){if("missing"===r.message)return t.put({_id:"userPrefs",currentFile:null});e.catchDbError(r)}),t.changes({since:"now",live:!0,include_docs:!0}).on("change",function(t){"userPrefs"===t.id?(e.lastFile!==t.doc.currentFile&&(e.lastFile=t.doc.currentFile,s(regeneratorRuntime.mark(function t(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.getFileList();case 2:r=t.sent,e.trigger("fileListChange",r);case 4:case"end":return t.stop()}},t,e)}))().catch(e.catchDbError)),s(regeneratorRuntime.mark(function r(){var n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.getFile(t.doc.currentFile);case 2:n=r.sent,e.trigger("fileChange",n);case 4:case"end":return r.stop()}},r,e)}))().catch(e.catchDbError)):t.deleted&&t.id!==e.lastFile?s(regeneratorRuntime.mark(function t(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.getFileList();case 2:r=t.sent,e.trigger("fileListChange",r);case 4:case"end":return t.stop()}},t,e)}))().catch(e.catchDbError):e.trigger("fileSave")}).on("error",function(t){e.catchDbError(t)}),t}},{key:"setCurrentFile",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.db.get("userPrefs").then(function(e){return e.currentFile=t,r.db.put(e)}).catch(this.catchDbError));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getCurrentFilename",value:function(){var e=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.db.get("userPrefs").then(function(e){return e.currentFile}));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getFile",value:function(){var e=s(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}return e.next=3,this.getCurrentFilename();case 3:t=e.sent;case 4:if(null===t){e.next=8;break}return e.abrupt("return",this.db.get(t,{attachments:!!r}).then(function(e){var r={filename:t,metadata:e.metadata,_rev:e._rev};return e._attachments[t].data&&(r.base64string=e._attachments[t].data),r}).catch(this.catchDbError));case 8:return e.abrupt("return",Promise.resolve(null));case 9:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"getMetadata",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getFile(t);case 2:return r=e.sent,e.abrupt("return",null!==r?r.metadata:null);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getFileAsBlob",value:function(){var e=s(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}return e.next=3,this.getCurrentFilename();case 3:t=e.sent;case 4:if(null===t){e.next=8;break}return e.abrupt("return",this.db.getAttachment(t,t).catch(this.catchDbError));case 8:return e.abrupt("return",Promise.resolve(null));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getFileAsDOM",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getFile(t,!0);case 2:if(null===(r=e.sent)){e.next=8;break}return n=window.atob(r.base64string),e.abrupt("return",new Promise(function(e,t){e((new window.DOMParser).parseFromString(n,"image/svg+xml"))}));case 8:return e.abrupt("return",Promise.resolve(null));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"on",value:function(e,t){if(!a.VALID_EVENTS[e])throw new Error("Unknown event name: "+e);d(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"on",this).call(this,e,t)}},{key:"customizeAlertDialog",value:function(e){this.alert=e}},{key:"customizeConfirmDialog",value:function(e){this.confirm=e}},{key:"customizePromptDialog",value:function(e){this.prompt=e}},{key:"openApp",value:function(e,t){t?window.open("/"+e,"_blank"):window.location.pathname="/"+e}},{key:"saveFile",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=void 0,t.filename){e.next=6;break}return e.next=5,this.getCurrentFilename();case 5:t.filename=e.sent;case 6:if(t.blobOrBase64string){e.next=12;break}return e.next=9,this.db.get(t.filename);case 9:r=e.sent,e.next=21;break;case 12:return e.next=14,this.db.get(t.filename,{attachments:!0});case 14:if(r=e.sent,r._attachments[t.filename].data=t.blobOrBase64string,t.metadata&&0!==Object.keys(t.metadata).length||!(Object.keys(r.metadata)>0)){e.next=21;break}return e.next=19,this.confirm("It appears that the file you're uploading has lost its Mure metadata. This is fairly common when you've edited it with an external program.\n\nRestore the most recent metadata?");case 19:(n=e.sent)||(r.metadata={});case 21:return t.metadata&&(r.metadata=t.metadata),e.next=24,this.db.put(r);case 24:return e.abrupt("return",e.sent);case 27:if(e.prev=27,e.t0=e.catch(0),"missing"!==e.t0.message){e.next=38;break}return i={_id:t.filename,_attachments:{},metadata:t.metadata||{}},t.blobOrBase64string||this.trigger("error","Attempted to save a file without contents!"),i._attachments[t.filename]={content_type:"image/svg+xml",data:t.blobOrBase64string},e.next=35,this.db.put(i);case 35:return e.abrupt("return",e.sent);case 38:return this.catchDbError(e.t0),e.abrupt("return",Promise.reject(e.t0));case 40:case"end":return e.stop()}},e,this,[[0,27]])}));return function(t){return e.apply(this,arguments)}}()},{key:"getFileList",value:function(){var e=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.db.allDocs().then(function(e){var t=[];return e.rows.forEach(function(e){"userPrefs"!==e.id&&t.push(e.id)}),t}).catch(this.catchDbError));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getFileRevisions",value:function(){var e=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.db.allDocs().then(function(e){var t={};return e.rows.forEach(function(e){"userPrefs"!==e.id&&(t[e.id]=e.value.rev)}),t}).catch(this.catchDbError));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"readFile",value:function(){var e=s(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e,n){t.onloadend=function(t){e(t.target.result)},t.onerror=function(e){n(e)},t.onabort=function(){n(a.SIGNALS.cancelled)},t.readAsText(r)}));case 1:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"validateFileName",value:function(){var e=s(regeneratorRuntime.mark(function e(t,r,n){var i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=t;case 1:if(!r[i]){e.next=20;break}return e.next=4,this.prompt(u+" already exists. Pick a new name, or leave it the same to overwrite:",u);case 4:if(null!==(u=e.sent)){e.next=10;break}return n&&n(),e.abrupt("return",Promise.reject(a.SIGNALS.cancelled));case 10:if(""!==u){e.next=16;break}return e.next=13,this.prompt("You must enter a file name (or hit cancel to cancel the upload)");case 13:u=e.sent,e.next=18;break;case 16:if(u!==t){e.next=18;break}return e.abrupt("return",u);case 18:e.next=1;break;case 20:return e.abrupt("return",i);case 21:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"matchDataPaths",value:function(e,t,r){if(!(r&&r.datasets&&e&&t))return!1;var i=n.query(r.datasets,e),a=n.query(r.datasets,t);return 1===i.length&&1===a.length&&i[0]===a[0]}},{key:"matchDomSelectors",value:function(e,t,r){return!(!e||!t)&&r.querySelector(e)===r.querySelector(t)}},{key:"inferParser",value:function(e){var t=e.type.split("/")[1];return"csv"===t?function(e){return r.read(e,{type:"csv",parse:"auto"})}:"tsv"===t?function(e){return r.read(e,{type:"tsv",parse:"auto"})}:"dsv"===t?function(e){return r.read(e,{type:"dsv",parse:"auto"})}:"json"===t?function(e){return r.read(e,{type:"json",parse:"auto"})}:null}},{key:"uploadDataset",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,n,i,a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.inferParser(t)){e.next=4;break}return this.trigger("error","Unknown data file type: "+t.type),e.abrupt("return",Promise.reject());case 4:return e.next=6,this.getMetadata();case 6:if(null!==(n=e.sent)){e.next=10;break}return this.trigger("error","Can't embed a data file without an SVG file already open"),e.abrupt("return",Promise.reject());case 10:return n.datasets=n.datasets||{},i=new window.FileReader,e.next=14,this.readFile(i,t);case 14:return a=e.sent,e.next=17,this.validateFileName(t.name,n.datasets,i.abort);case 17:return u=e.sent,n.datasets[u]=r(a),e.abrupt("return",this.saveFile({metadata:n}));case 20:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"uploadSvg",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,n,i,u=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=new window.FileReader,n=this.readFile(r,t).then(function(e){var t=(new window.DOMParser).parseFromString(e,"image/svg+xml"),r={metadata:u.extractMetadata(t)};return r.base64data=window.btoa((new window.XMLSerializer).serializeToString(t)),r}),i=this.getFileRevisions().catch(this.catchDbError).then(function(e){return u.validateFileName(t.name,e,r.abort)}),e.abrupt("return",Promise.all([i,n]).then(function(e){var t=f(e,2),r=t[0],n=t[1];return u.saveFile({filename:r,blobOrBase64string:n.base64data,metadata:n.metadata}).then(function(){return u.setCurrentFile(r)})}).catch(function(e){return e[0]===a.SIGNALS.cancelled&&e[1]===a.SIGNALS.cancelled?void 0:Promise.reject(e)}));case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"deleteSvg",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.confirm("Are you sure you want to delete "+t+"?");case 2:if(!(r=e.sent)){e.next=7;break}return e.abrupt("return",Promise.all([this.db.get(t),this.getCurrentFilename()]).then(function(e){var r=e[0],i=e[1];return n.db.remove(r._id,r._rev).then(function(e){return t===i&&n.setCurrentFile(null).catch(n.catchDbError),e})}).catch(this.catchDbError));case 7:return e.abrupt("return",Promise.resolve(!1));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"extractMetadata",value:function(e){var r=this,n={},i=t.select(e.rootElement).select("#mure");if(0===i.size())return n;var a=i.select("mure");return 0===a.size()?n:(a.selectAll("library").each(function(e){n.libraries||(n.libraries=[]),n.libraries.push(t.select(this).attr("src"))}),a.selectAll("script").each(function(e){var i=t.select(this),a={text:r.extractCDATA(i.text())},u=i.attr("id");if(u){if("mureInteractivityRunner"===u)return;a.id=u}n.scripts||(n.scripts=[]),n.scripts.push(a)}),a.selectAll("datasets").each(function(e){var i=t.select(this);n.datasets||(n.datasets={}),n.datasets[i.attr("name")]=JSON.parse(r.extractCDATA(i.text()))}),a.selectAll("binding").each(function(e){var i=t.select(this),a={id:i.attr("id"),dataRoot:i.attr("dataroot"),svgRoot:i.attr("svgroot"),keyFunction:JSON.parse(r.extractCDATA(i.text()))};n.bindings||(n.bindings={}),n.bindings[a.id]=a}),a.selectAll("encoding").each(function(e){var i=t.select(this),a={id:i.attr("id"),bindingId:i.attr("for"),spec:JSON.parse(r.extractCDATA(i.text()))};n.encodings||(n.encodings={}),n.encodings[a.id]=a}),n)}},{key:"extractCDATA",value:function(e){return e.replace(/(<!\[CDATA\[)/g,"").replace(/]]>/g,"")}},{key:"getEmptyBinding",value:function(e,t){for(var r=1;e.bindings&&e.bindings["Binding"+r];)r++;var n={id:"Binding"+r,svgRoot:"",dataRoot:"",keyFunction:{dataExpression:"(d, i) => i",svgExpression:"(el, i, d3el, $el) => i"}};return t&&(e.bindings||(e.bindings={}),e.bindings[n.id]=n),n}},{key:"getEmptyEncoding",value:function(e,t){for(var r=1;e.encodings&&e.encodings["Encoding"+r];)r++;var n={id:"Encoding"+r,bindingId:null,spec:{}};return t&&(e.encodings||(e.encodings={}),e.encodings[n.id]=n),n}},{key:"embedMetadata",value:function(e,r){var n=t.select(e.rootElement),i=n.selectAll("#mure").data([0]);i.exit().remove();var a=(i=i.enter().append("metadata").attr("id","mure").merge(i)).selectAll("mure").data([0]);a.exit().remove(),a=a.enter().append("mure").attr("xmlns",this.NSString).merge(a);var u=r.libraries||[],o=a.selectAll("library").data(u);o.exit().remove(),(o=o.enter().append("library").merge(o)).attr("src",function(e){return e});var s=r.scripts||[],c=a.selectAll("script").data(s);c.exit().remove(),(c=c.enter().append("script").merge(c)).attr("id",function(e){return e.id||null}),c.each(function(e){this.innerHTML="<![CDATA["+e.text+"]]>"}),n.select("#mureInteractivityRunner").remove(),(u.length>0||s.length>0)&&n.append("script").attr("id","mureInteractivityRunner").attr("type","text/javascript").text("<![CDATA[\n/* globals XMLHttpRequest, ActiveXObject */\n/* eslint no-eval: 0 */\n/* exported mureInteractivity */\nvar mureInteractivity = {\n  getData: function () {\n    return 'TODO';\n  }\n};\n\n(function () {\n  function load (url, callback) {\n    let xhr;\n    if (typeof XMLHttpRequest !== 'undefined') {\n      xhr = new XMLHttpRequest();\n    } else {\n      let versions = [\n        'MSXML2.XmlHttp.5.0',\n        'MSXML2.XmlHttp.4.0',\n        'MSXML2.XmlHttp.3.0',\n        'MSXML2.XmlHttp.2.0',\n        'Microsoft.XmlHttp'\n      ];\n      for (let i = 0, len = versions.length; i < len; i++) {\n        try {\n          xhr = new ActiveXObject(versions[i]);\n          break;\n        } catch (e) {}\n      }\n    }\n\n    xhr.onreadystatechange = ensureReadiness;\n\n    function ensureReadiness () {\n      if (xhr.readyState < 4) {\n        return;\n      }\n\n      if (xhr.status !== 200) {\n        return;\n      }\n\n      // all is well\n      if (xhr.readyState === 4) {\n        callback(xhr.responseText);\n      }\n    }\n\n    xhr.open('GET', url, true);\n    xhr.send('');\n  }\n\n  function loadUserLibraries (callback) {\n    // Grab all the mure:library tags, and load the referenced library (script src attributes\n    // in SVG don't work, so we have to manually load remote libraries)\n    let libraries = Array.from(document.getElementsByTagNameNS('http://mure-apps.github.io', 'library'))\n      .map(libraryTag => libraryTag.getAttribute('src'));\n\n    let loadedLibraries = {};\n    let onloadFired = false;\n\n    libraries.forEach(function (script) {\n      load(script, function (scriptText) {\n        window.eval(scriptText);\n        loadedLibraries[script] = true;\n        attemptStart();\n      });\n    });\n\n    window.onload = function () {\n      onloadFired = true;\n      attemptStart();\n    };\n\n    function attemptStart () {\n      if (!onloadFired) {\n        return;\n      }\n      let allLoaded = libraries.every(script => {\n        return loadedLibraries[script];\n      });\n      if (allLoaded) {\n        callback();\n      }\n    }\n  }\n\n  function runUserScripts () {\n    Array.from(document.getElementsByTagNameNS('http://mure-apps.github.io', 'script'))\n      .forEach(scriptTag => window.eval(scriptTag.textContent));\n  }\n\n  // Where we actually start executing stuff:\n  if (!window.frameElement ||\n      !window.frameElement.__suppressInteractivity__) {\n    // We've been loaded directly into a browser, or embedded in a normal page;\n    // load all the libraries, and then run all the scripts\n    loadUserLibraries(runUserScripts);\n  }\n})();\n]]");var l=a.selectAll("dataset").data(t.entries(r.datasets||{}));l.exit().remove(),(l=l.enter().append("dataset").merge(l)).attr("name",function(e){return e.key}).html(function(e){return"<![CDATA["+JSON.stringify(e.value)+"]]>"});var d=a.selectAll("binding").data(t.values(r.bindings||{}));d.exit().remove(),(d=d.enter().append("binding").merge(d)).attr("id",function(e){return e.id}).attr("dataroot",function(e){return e.dataRoot}).attr("svgroot",function(e){return e.svgRoot}).html(function(e){return"<![CDATA["+JSON.stringify(e.keyFunction)+"]]>"});var p=a.selectAll("encoding").data(t.values(r.encodings||{}));p.exit().remove(),(p=p.enter().append("encoding").merge(p)).attr("id",function(e){return e.id}).attr("bindingid",function(e){return e.bindingId}).html(function(e){return"<![CDATA["+JSON.stringify(e.spec)+"]]>"})}},{key:"downloadSvg",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,n,i,a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0,e.prev=1,e.next=4,this.getFile(t,!0);case 4:r=e.sent,e.next=11;break;case 7:return e.prev=7,e.t0=e.catch(1),this.catchDbError(e.t0),e.abrupt("return");case 11:n=window.atob(r.base64string),i=(new window.DOMParser).parseFromString(n,"image/svg+xml"),this.embedMetadata(i,r.metadata),n=(new window.XMLSerializer).serializeToString(i),n=n.replace(/&lt;!\[CDATA\[/g,"<![CDATA[").replace(/]]&gt;/g,"]]>"),(a=document.createElement("a")).style="display:none",u=window.URL.createObjectURL(new window.Blob([n],{type:"image/svg+xml"})),a.href=u,a.download=t,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(u),a.parentNode.removeChild(a);case 25:case"end":return e.stop()}},e,this,[[1,7]])}));return function(t){return e.apply(this,arguments)}}()}]),a}(a.Model);return h.VALID_EVENTS={fileListChange:!0,fileChange:!0,fileSave:!0,error:!0},h.SIGNALS={cancelled:!0},new h});