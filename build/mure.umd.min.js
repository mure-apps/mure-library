!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("babel-polyfill"),require("d3"),require("jquery"),require("datalib"),require("md5"),require("jsonpath"),require("pouchdb"),require("uki")):"function"==typeof define&&define.amd?define(["babel-polyfill","d3","jquery","datalib","md5","jsonpath","pouchdb","uki"],t):e.mure=t(null,e.d3,e.jQuery,e.datalib,e.md5,e.jsonpath,e.PouchDB,e.uki)}(this,function(e,t,n,r,a,i,u,o){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n,r=r&&r.hasOwnProperty("default")?r.default:r,a=a&&a.hasOwnProperty("default")?a.default:a,u=u&&u.hasOwnProperty("default")?u.default:u;var s={docs:{name:"docs",description:"The core app / landing page for Mure",author:"Alex Bigelow",icon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIxLjAuMiwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe2ZpbGw6I0U2QUIwMjt9Cgkuc3Qxe29wYWNpdHk6MC4zO2ZpbGw6Izc1NzBCMztlbmFibGUtYmFja2dyb3VuZDpuZXcgICAgO30KCS5zdDJ7b3BhY2l0eTowLjQ1O2ZpbGw6I0U2QUIwMjtlbmFibGUtYmFja2dyb3VuZDpuZXcgICAgO30KCS5zdDN7b3BhY2l0eTowLjU1O2ZpbGw6Izc1NzBCMztlbmFibGUtYmFja2dyb3VuZDpuZXcgICAgO30KCS5zdDR7b3BhY2l0eTowLjI7ZmlsbDojRTZBQjAyO2VuYWJsZS1iYWNrZ3JvdW5kOm5ldyAgICA7fQoJLnN0NXtmaWxsOiM3NTcwQjM7fQo8L3N0eWxlPgo8cG9seWdvbiBjbGFzcz0ic3QwIiBwb2ludHM9IjMzOS4zLDQwNy4zIDI1Niw1MDYgMTcyLjcsNDA3LjMgIi8+Cjxwb2x5Z29uIGNsYXNzPSJzdDEiIHBvaW50cz0iMjE0LjEsMzcyLjIgMjk3LjUsMjczLjUgMzgwLjgsMzcyLjIgIi8+Cjxwb2x5Z29uIGNsYXNzPSJzdDIiIHBvaW50cz0iNTA2LDI3My41IDQyMi43LDM3Mi4yIDMzOS4zLDI3My41ICIvPgo8cG9seWdvbiBjbGFzcz0ic3QzIiBwb2ludHM9IjI1NiwyMzguNSAzMzkuMywxMzkuOCA0MjIuNywyMzguNSAiLz4KPHBvbHlnb24gY2xhc3M9InN0MiIgcG9pbnRzPSIyNTYsMjczLjUgMTcyLjcsMzcyLjIgODkuMywyNzMuNSAiLz4KPHBvbHlnb24gY2xhc3M9InN0MyIgcG9pbnRzPSI2LDIzOC41IDg5LjMsMTM5LjggMTcyLjcsMjM4LjUgIi8+Cjxwb2x5Z29uIGNsYXNzPSJzdDQiIHBvaW50cz0iMjk3LjUsMTM5LjggMjE0LjEsMjM4LjUgMTMwLjgsMTM5LjggIi8+Cjxwb2x5Z29uIGNsYXNzPSJzdDUiIHBvaW50cz0iMTcyLjcsMTA0LjcgMjU2LDYgMzM5LjMsMTA0LjcgIi8+Cjwvc3ZnPgo="},"data-binder":{name:"data-binder",description:"A Mure app that is responsible for (re)binding data to graphics",author:"Alex Bigelow",icon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIxLjEuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe29wYWNpdHk6MC42O2ZpbGw6I0U2QUIwMjt9Cgkuc3Qxe29wYWNpdHk6MC4zO2ZpbGw6I0U2QUIwMjt9Cgkuc3Qye29wYWNpdHk6MC42O2ZpbGw6Izc1NzBCMzt9Cgkuc3Qze2ZpbGw6Izc1NzBCMzt9Cgkuc3Q0e29wYWNpdHk6MC4zO2ZpbGw6Izc1NzBCMzt9Cgkuc3Q1e2ZpbGw6I0U2QUIwMjt9Cjwvc3R5bGU+CjxnPgoJPHBhdGggY2xhc3M9InN0MCIgZD0iTTExOS43LDI2Ny43di0yMy40YzU5LjYsMCw3Ny4zLTE5LjcsODMuMi0yNi4xYzE0LjEtMTUuNywxOS0zNy40LDI0LjItNjAuNGM1LjQtMjQsMTEtNDguOSwyNy45LTY4LjMKCQlDMjc0LjEsNjcuNiwzMDQuNiw1NywzNDguMyw1N3YyMy40Yy0zNi41LDAtNjEuMyw4LTc1LjgsMjQuNWMtMTMsMTQuOS0xNy43LDM1LjgtMjIuNyw1OGMtNS42LDI0LjktMTEuNCw1MC42LTI5LjYsNzAuOQoJCUMxOTkuNywyNTYuNiwxNjYuOCwyNjcuNywxMTkuNywyNjcuN3oiLz4KCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0xMTkuNyw0NTV2LTIzLjRjMzQuNCwwLDk0LjMtNDAuMiwxNjQuNC0xMTAuM2wxNi42LDE2LjZDMjQ3LjEsMzkxLjMsMTcyLjQsNDU1LDExOS43LDQ1NXoiLz4KCTxwYXRoIGNsYXNzPSJzdDIiIGQ9Ik03LjUsMjk5LjVjMzIuNy0yNi43LDU2LjYtNDcuMiw1Ni42LTYzLjhjMC0xMS03LTE2LjItMTcuOC0xNi4yYy05LjEsMC0xNi4yLDUuOC0yMi44LDExLjZMNiwyMTMuMwoJCWMxMy4zLTEzLjUsMjUuNy0xOS43LDQ1LTE5LjdjMjYuMywwLDQ0LjcsMTUuOSw0NC43LDQwLjJjMCwxOS43LTIwLjUsNDEuNC00MC42LDU4LjRjNi44LTAuOCwxNi0xLjUsMjItMS41aDI0Ljd2MjcuOEg3LjVWMjk5LjV6IgoJCS8+Cgk8cGF0aCBjbGFzcz0ic3QzIiBkPSJNOC4yLDEwMy45SDM5VjM5LjNIMTMuNFYxOC41YzE1LTIuOCwyNC44LTYuMywzNC43LTEyLjJoMjQuOHY5Ny43aDI2Ljh2MjcuMkg4LjJWMTAzLjl6Ii8+Cgk8cGF0aCBjbGFzcz0ic3Q0IiBkPSJNNi41LDQ4OC43bDE0LjgtMjAuNWM4LDYuOCwxOC4yLDExLjQsMjcuMywxMS40YzExLjgsMCwyMC4xLTMuOCwyMC4xLTExLjRjMC05LjEtNi42LTE0LjQtMzMuNC0xNC40VjQzMQoJCWMyMS42LDAsMjkuNi01LjMsMjkuNi0xMy43YzAtNy4yLTUuNy0xMS0xNS4yLTExYy04LjcsMC0xNS42LDMuNC0yMy45LDkuOUw5LjUsMzk2LjRjMTIuMy05LjksMjYuMi0xNS42LDQxLjgtMTUuNgoJCWMyNy43LDAsNDYuMywxMi4xLDQ2LjMsMzRjMCwxMS42LTcuOCwyMC4zLTIyLDI2djAuOGMxNC44LDQuMiwyNS44LDEzLjcsMjUuOCwyOC44YzAsMjIuOC0yMy4zLDM1LjMtNDkuMywzNS4zCgkJQzMxLjUsNTA1LjgsMTYsNDk5LjMsNi41LDQ4OC43eiIvPgoJPHJlY3QgeD0iMzA1LjQiIHk9IjE5MS42IiBjbGFzcz0ic3Q0IiB3aWR0aD0iMTI0LjkiIGhlaWdodD0iMTI0LjkiLz4KCTxjaXJjbGUgY2xhc3M9InN0MiIgY3g9IjQzNy43IiBjeT0iNzQuNSIgcj0iNjguMyIvPgoJPHBvbHlnb24gY2xhc3M9InN0MyIgcG9pbnRzPSI0MjcuMSwzNjkuMiAzNDguMyw1MDUuOCA1MDYsNTA1LjggCSIvPgoJPHBhdGggY2xhc3M9InN0NSIgZD0iTTM1My45LDQ0OS4yYy0zNC42LDAtNjUtNC41LTkwLjMtMTMuM2MtMjMuOC04LjMtNDMuOS0yMC43LTU5LjgtMzYuOGMtNTMtNTMuNy01MS44LTE0MC01MC45LTIwOS4zCgkJYzAuNi00NC44LDEuMi04Ny4yLTE0LTEwMi41Yy00LjYtNC43LTEwLjctNi44LTE5LjItNi44VjU3YzE0LjgsMCwyNi45LDQuNiwzNS45LDEzLjhjMjIsMjIuMywyMS40LDY3LjMsMjAuNywxMTkuMwoJCWMtMC45LDY4LjMtMiwxNDUuNyw0NC4yLDE5Mi41YzI4LjcsMjkuMSw3Mi4zLDQzLjIsMTMzLjUsNDMuMlY0NDkuMnoiLz4KPC9nPgo8L3N2Zz4K"}},c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l=(function(){function e(e){this.value=e}function t(t){function n(a,i){try{var u=t[a](i),o=u.value;o instanceof e?Promise.resolve(o.value).then(function(e){n("next",e)},function(e){n("throw",e)}):r(u.done?"return":"normal",u.value)}catch(e){r("throw",e)}}function r(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}(a=a.next)?n(a.key,a.arg):i=null}var a,i;this._invoke=function(e,t){return new Promise(function(r,u){var o={key:e,arg:t,resolve:r,reject:u,next:null};i?i=i.next=o:(a=i=o,n(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(a,i){try{var u=t[a](i),o=u.value}catch(e){return void n(e)}if(!u.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}),d=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},p=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),g=function e(t,n,r){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,n);if(void 0===a){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,r)}if("value"in a)return a.value;var u=a.get;if(void 0!==u)return u.call(r)},f=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},y=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},m=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var u,o=e[Symbol.iterator]();!(r=(u=o.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),M=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)};return new(function(e){function o(){d(this,o);var e=y(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));if(e.appList=s,"undefined"==typeof document||"undefined"==typeof window)return y(e);e.VALID_EVENTS={fileListChange:{},fileChange:{},domChange:{},metadataChange:{},error:{}},e.CONTENT_FORMATS={exclude:0,blob:1,dom:2,base64:3},e.SIGNALS={cancelled:{}},e.NSString="http://mure-apps.github.io",t.namespaces.mure=e.NSString;var n=document.getElementsByTagName("title")[0];return n=n?n.textContent:"",e.debugMode="localhost"===window.location.hostname&&n.startsWith("Mure"),e.currentApp=window.location.pathname.replace(/\//g,""),e.appList[e.currentApp]||(e.currentApp=null),e.lastFile=null,e.db=e.getOrInitDb(),e.on("error",function(e){console.warn(e)}),e.catchDbError=function(t){e.trigger("error","Unexpected error reading PouchDB: "+t.message+"\n"+t.stack)},e.alert=function(e){return new Promise(function(t,n){window.alert(e),t(!0)})},e.confirm=function(e){return new Promise(function(t,n){t(window.confirm(e))})},e.prompt=function(e,t){return new Promise(function(n,r){n(window.prompt(e,t))})},e}return f(o,e),p(o,[{key:"on",value:function(e,t){if(!this.VALID_EVENTS[e])throw new Error("Unknown event name: "+e);g(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"on",this).call(this,e,t)}},{key:"customizeAlertDialog",value:function(e){this.alert=e}},{key:"customizeConfirmDialog",value:function(e){this.confirm=e}},{key:"customizePromptDialog",value:function(e){this.prompt=e}},{key:"openApp",value:function(e,t){t?window.open("/"+e,"_blank"):window.location.pathname="/"+e}},{key:"getOrInitDb",value:function(){var e=this,t=new u("mure");return l(regeneratorRuntime.mark(function n(){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e.lastFile=null,n.prev=1,n.next=4,t.get("userPrefs");case 4:if(!(r=n.sent).currentFile){n.next=9;break}return n.next=8,e.getFile(r.currentFile);case 8:e.lastFile=n.sent;case 9:n.next=14;break;case 11:n.prev=11,n.t0=n.catch(1),"missing"===n.t0.message?t.put({_id:"userPrefs",currentFile:null}):e.catchDbError(n.t0);case 14:case"end":return n.stop()}},n,e,[[1,11]])}))(),t.changes({since:"now",live:!0,include_docs:!0}).on("change",function(t){var n=void 0,r=void 0,a=void 0,i=void 0;if(t.deleted)t.doc._id!==e.lastFile._id&&l(regeneratorRuntime.mark(function t(){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.getFileList();case 2:n=t.sent,e.trigger("fileListChange",n);case 4:case"end":return t.stop()}},t,e)}))().catch(e.catchDbError);else{var u=void 0;"userPrefs"===t.doc._id?(n=r=a=i=!0,u=e.lastFile):(null===e.lastFile||e.lastFile._id!==t.doc._id?n=r=a=i=!1:(n=!1,a=e.lastFile._attachments[e.lastFile._id].digest!==t.doc._attachments[t.doc._id].digest,i=e.lastFile.metadataDigest!==t.doc.metadataDigest),e.lastFile=u=t.doc),n&&e.trigger("fileChange",u),r&&l(regeneratorRuntime.mark(function t(){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.getFileList();case 2:n=t.sent,e.trigger("fileListChange",n);case 4:case"end":return t.stop()}},t,e)}))().catch(e.catchDbError),a&&l(regeneratorRuntime.mark(function t(){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!u){t.next=6;break}return t.next=3,e.getFileAsBlob(u._id);case 3:t.t0=t.sent,t.next=7;break;case 6:t.t0=null;case 7:n=t.t0,e.trigger("domChange",n);case 9:case"end":return t.stop()}},t,e)}))(),i&&e.trigger("metadataChange",u?u.metadata:null)}}).on("error",function(t){e.catchDbError(t)}),t}},{key:"setCurrentFile",value:function(){var e=l(regeneratorRuntime.mark(function e(t){var n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.db.get("userPrefs").then(function(e){return e.currentFile=t,n.db.put(e)}).catch(this.catchDbError));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getFile",value:function(){var e=l(regeneratorRuntime.mark(function e(t,n){var r,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}return e.next=3,this.getCurrentFilename();case 3:t=e.sent;case 4:if(r={},n!==this.CONTENT_FORMATS.exclude&&(r.attachments=!0,n===this.CONTENT_FORMATS.blob&&(r.binary=!0)),null===t){e.next=10;break}return e.abrupt("return",this.db.get(t,r||{}).then(function(e){if(n===a.CONTENT_FORMATS.dom){var t=window.atob(e._attachments[e._id].data),r=(new window.DOMParser).parseFromString(t,"image/svg+xml");e._attachments[e._id].dom=r}return e}));case 10:return e.abrupt("return",Promise.resolve(null));case 11:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"saveFile",value:function(){var e=l(regeneratorRuntime.mark(function e(t){var n,r,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=void 0,t.blobOrBase64string){e.next=8;break}return e.next=5,this.getFile(t.filename,this.CONTENT_FORMATS.exclude);case 5:n=e.sent,e.next=17;break;case 8:return e.next=10,this.getFile(t.filename,this.CONTENT_FORMATS.blob);case 10:if(n=e.sent,n._attachments[t.filename].data=t.blobOrBase64string,t.metadata&&0!==Object.keys(t.metadata).length||!(Object.keys(n.metadata)>0)){e.next=17;break}return e.next=15,this.confirm("It appears that the file you're uploading has lost its Mure metadata. This is fairly common when you've edited it with an external program.\n\nRestore the most recent metadata?");case 15:(r=e.sent)||(n.metadata={},n.metadataDigest=a("{}"));case 17:return t.metadata&&(n.metadata=t.metadata,n.metadataDigest=a(JSON.stringify(t.metadata))),e.abrupt("return",this.db.put(n));case 21:if(e.prev=21,e.t0=e.catch(0),"missing"!==e.t0.message){e.next=30;break}return i={_id:t.filename,_attachments:{},metadata:t.metadata||{},metadataDigest:a(t.metadata?JSON.stringify(t.metadata):"{}")},t.blobOrBase64string||this.trigger("error","Attempted to save a file without contents!"),i._attachments[t.filename]={content_type:"image/svg+xml",data:t.blobOrBase64string},e.abrupt("return",this.db.put(i));case 30:return this.catchDbError(e.t0),e.abrupt("return",Promise.reject(e.t0));case 32:case"end":return e.stop()}},e,this,[[0,21]])}));return function(t){return e.apply(this,arguments)}}()},{key:"getMetadata",value:function(){var e=l(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getFile(t,this.CONTENT_FORMATS.exclude);case 2:return n=e.sent,e.abrupt("return",null!==n?n.metadata:null);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getCurrentFilename",value:function(){var e=l(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.db.get("userPrefs").then(function(e){return e.currentFile}));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getFileList",value:function(){var e=l(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.db.allDocs().then(function(e){var t=[];return e.rows.forEach(function(e){"userPrefs"!==e.id&&t.push(e.id)}),t}).catch(this.catchDbError));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getFileRevisions",value:function(){var e=l(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.db.allDocs().then(function(e){var t={};return e.rows.forEach(function(e){"userPrefs"!==e.id&&(t[e.id]=e.value.rev)}),t}).catch(this.catchDbError));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"readFile",value:function(){var e=l(regeneratorRuntime.mark(function e(t,n){var r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e,a){t.onloadend=function(t){e(t.target.result)},t.onerror=function(e){a(e)},t.onabort=function(){a(r.SIGNALS.cancelled)},t.readAsText(n)}));case 1:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"validateFileName",value:function(){var e=l(regeneratorRuntime.mark(function e(t,n,r){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=t;case 1:if(!n[a]){e.next=20;break}return e.next=4,this.prompt(a+" already exists. Pick a new name, or leave it the same to overwrite:",a);case 4:if(null!==(a=e.sent)){e.next=10;break}return r&&r(),e.abrupt("return",Promise.reject(this.SIGNALS.cancelled));case 10:if(""!==a){e.next=16;break}return e.next=13,this.prompt("You must enter a file name (or click cancel to cancel the upload)");case 13:a=e.sent,e.next=18;break;case 16:if(a!==t){e.next=18;break}return e.abrupt("return",a);case 18:e.next=1;break;case 20:return e.abrupt("return",a);case 21:case"end":return e.stop()}},e,this)}));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"inferParser",value:function(e){var t=e.type.split("/")[1];return"csv"===t?function(e){return r.read(e,{type:"csv",parse:"auto"})}:"tsv"===t?function(e){return r.read(e,{type:"tsv",parse:"auto"})}:"dsv"===t?function(e){return r.read(e,{type:"dsv",parse:"auto"})}:"json"===t?function(e){return r.read(e,{type:"json",parse:"auto"})}:null}},{key:"uploadDataset",value:function(){var e=l(regeneratorRuntime.mark(function e(t){var n,r,a,i,u,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.inferParser(t)){e.next=5;break}return r=new Error("Unknown data file type: "+t.type),this.trigger("error",r),e.abrupt("return",Promise.reject(r));case 5:return e.next=7,this.getMetadata();case 7:if(null!==(a=e.sent)){e.next=12;break}return i=new Error("Can't embed a data file without an SVG file already open"),this.trigger("error",i),e.abrupt("return",Promise.reject(i));case 12:return a.datasets=a.datasets||{},u=new window.FileReader,e.next=16,this.validateFileName(t.name,a.datasets,u.abort);case 16:return o=e.sent,e.next=19,this.readFile(u,t);case 19:return s=e.sent,a.datasets[o]=n(s),e.abrupt("return",this.saveFile({metadata:a}));case 22:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"uploadSvg",value:function(){var e=l(regeneratorRuntime.mark(function e(t){var n,r,a,i=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new window.FileReader,r=this.readFile(n,t).then(function(e){var t=(new window.DOMParser).parseFromString(e,"image/svg+xml"),n={metadata:i.extractMetadata(t)};return n.base64data=window.btoa((new window.XMLSerializer).serializeToString(t)),n}),a=this.getFileRevisions().catch(this.catchDbError).then(function(e){return i.validateFileName(t.name,e,n.abort)}),e.abrupt("return",Promise.all([a,r]).then(function(e){var t=m(e,2),n=t[0],r=t[1];return i.saveFile({filename:n,blobOrBase64string:r.base64data,metadata:r.metadata}).then(function(){return i.setCurrentFile(n)})}).catch(function(e){if(e[0]!==i.SIGNALS.cancelled||e[1]!==i.SIGNALS.cancelled)return Promise.reject(e)}));case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"deleteSvg",value:function(){var e=l(regeneratorRuntime.mark(function e(t){var n,r,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.confirm("Are you sure you want to delete "+t+"?");case 2:if(!(n=e.sent)){e.next=10;break}return e.next=6,this.getFile(t,this.CONTENT_FORMATS.exclude);case 6:return r=e.sent,e.abrupt("return",this.db.remove(r._id,r._rev).then(function(e){return a.lastFile&&t===a.lastFile._id?a.setCurrentFile(null).then(function(){return e}):e}));case 10:return e.abrupt("return",Promise.resolve(!1));case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"extractMetadata",value:function(e){var n=this,r={},a=t.select(e.rootElement).select("#mure");if(0===a.size())return r;var i=a.select("mure");return 0===i.size()?r:(i.selectAll("library").each(function(e){r.libraries||(r.libraries=[]),r.libraries.push(t.select(this).attr("src"))}),i.selectAll("script").each(function(e){var a=t.select(this),i={text:n.extractCDATA(a.text())},u=a.attr("id");if(u){if("mureInteractivityRunner"===u)return;i.id=u}r.scripts||(r.scripts=[]),r.scripts.push(i)}),i.selectAll("datasets").each(function(e){var a=t.select(this);r.datasets||(r.datasets={}),r.datasets[a.attr("name")]=JSON.parse(n.extractCDATA(a.text()))}),i.selectAll("binding").each(function(e){var a=t.select(this),i={id:a.attr("id"),dataRoot:a.attr("dataroot"),svgRoot:a.attr("svgroot"),keyFunction:JSON.parse(n.extractCDATA(a.text()))};r.bindings||(r.bindings={}),r.bindings[i.id]=i}),i.selectAll("encoding").each(function(e){var a=t.select(this),i={id:a.attr("id"),bindingId:a.attr("for"),spec:JSON.parse(n.extractCDATA(a.text()))};r.encodings||(r.encodings={}),r.encodings[i.id]=i}),r)}},{key:"extractCDATA",value:function(e){return e.replace(/(<!\[CDATA\[)/g,"").replace(/]]>/g,"")}},{key:"getEmptyBinding",value:function(e,t){for(var n=1;e.bindings&&e.bindings["Binding"+n];)n++;var r={id:"Binding"+n,svgRoot:"",dataRoot:"",keyFunction:{dataExpression:"(d, k) => k",svgExpression:"(el, i) => i"}};return t&&(e.bindings||(e.bindings={}),e.bindings[r.id]=r),r}},{key:"getEmptyEncoding",value:function(e,t){for(var n=1;e.encodings&&e.encodings["Encoding"+n];)n++;var r={id:"Encoding"+n,bindingId:"",spec:{}};return t&&(e.encodings||(e.encodings={}),e.encodings[r.id]=r),r}},{key:"embedMetadata",value:function(e,n){var r=t.select(e.rootElement),a=r.selectAll("#mure").data([0]);a.exit().remove();var i=(a=a.enter().append("metadata").attr("id","mure").merge(a)).selectAll("mure").data([0]);i.exit().remove(),i=i.enter().append("mure").attr("xmlns",this.NSString).merge(i);var u=n.libraries||[],o=i.selectAll("library").data(u);o.exit().remove(),(o=o.enter().append("library").merge(o)).attr("src",function(e){return e});var s=n.scripts||[],c=i.selectAll("script").data(s);c.exit().remove(),(c=c.enter().append("script").merge(c)).attr("id",function(e){return e.id||null}),c.each(function(e){this.innerHTML="<![CDATA["+e.text+"]]>"}),r.select("#mureInteractivityRunner").remove(),(u.length>0||s.length>0)&&r.append("script").attr("id","mureInteractivityRunner").attr("type","text/javascript").text("<![CDATA[\n/* globals XMLHttpRequest, ActiveXObject */\n/* eslint no-eval: 0 */\n/* exported mureInteractivity */\nvar mureInteractivity = {\n  getData: function () {\n    return 'TODO';\n  }\n};\n\n(function () {\n  function load (url, callback) {\n    let xhr;\n    if (typeof XMLHttpRequest !== 'undefined') {\n      xhr = new XMLHttpRequest();\n    } else {\n      let versions = [\n        'MSXML2.XmlHttp.5.0',\n        'MSXML2.XmlHttp.4.0',\n        'MSXML2.XmlHttp.3.0',\n        'MSXML2.XmlHttp.2.0',\n        'Microsoft.XmlHttp'\n      ];\n      for (let i = 0, len = versions.length; i < len; i++) {\n        try {\n          xhr = new ActiveXObject(versions[i]);\n          break;\n        } catch (e) {}\n      }\n    }\n\n    xhr.onreadystatechange = ensureReadiness;\n\n    function ensureReadiness () {\n      if (xhr.readyState < 4) {\n        return;\n      }\n\n      if (xhr.status !== 200) {\n        return;\n      }\n\n      // all is well\n      if (xhr.readyState === 4) {\n        callback(xhr.responseText);\n      }\n    }\n\n    xhr.open('GET', url, true);\n    xhr.send('');\n  }\n\n  function loadUserLibraries (callback) {\n    // Grab all the mure:library tags, and load the referenced library (script src attributes\n    // in SVG don't work, so we have to manually load remote libraries)\n    let libraries = Array.from(document.getElementsByTagNameNS('http://mure-apps.github.io', 'library'))\n      .map(libraryTag => libraryTag.getAttribute('src'));\n\n    let loadedLibraries = {};\n    let onloadFired = false;\n\n    libraries.forEach(function (script) {\n      load(script, function (scriptText) {\n        window.eval(scriptText);\n        loadedLibraries[script] = true;\n        attemptStart();\n      });\n    });\n\n    window.onload = function () {\n      onloadFired = true;\n      attemptStart();\n    };\n\n    function attemptStart () {\n      if (!onloadFired) {\n        return;\n      }\n      let allLoaded = libraries.every(script => {\n        return loadedLibraries[script];\n      });\n      if (allLoaded) {\n        callback();\n      }\n    }\n  }\n\n  function runUserScripts () {\n    Array.from(document.getElementsByTagNameNS('http://mure-apps.github.io', 'script'))\n      .forEach(scriptTag => window.eval(scriptTag.textContent));\n  }\n\n  // Where we actually start executing stuff:\n  if (!window.frameElement ||\n      !window.frameElement.__suppressInteractivity__) {\n    // We've been loaded directly into a browser, or embedded in a normal page;\n    // load all the libraries, and then run all the scripts\n    loadUserLibraries(runUserScripts);\n  }\n})();\n]]");var l=i.selectAll("dataset").data(t.entries(n.datasets||{}));l.exit().remove(),(l=l.enter().append("dataset").merge(l)).attr("name",function(e){return e.key}).html(function(e){return"<![CDATA["+JSON.stringify(e.value)+"]]>"});var d=i.selectAll("binding").data(t.values(n.bindings||{}));d.exit().remove(),(d=d.enter().append("binding").merge(d)).attr("id",function(e){return e.id}).attr("dataroot",function(e){return e.dataRoot}).attr("svgroot",function(e){return e.svgRoot}).html(function(e){return"<![CDATA["+JSON.stringify(e.keyFunction)+"]]>"});var p=i.selectAll("encoding").data(t.values(n.encodings||{}));return p.exit().remove(),(p=p.enter().append("encoding").merge(p)).attr("id",function(e){return e.id}).attr("bindingid",function(e){return e.bindingId}).html(function(e){return"<![CDATA["+JSON.stringify(e.spec)+"]]>"}),e}},{key:"downloadSvg",value:function(){var e=l(regeneratorRuntime.mark(function e(t){var n,r,a,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getFile(t,this.CONTENT_FORMATS.dom);case 2:if(n=e.sent){e.next=5;break}throw new Error("Can't download non-existent file: "+t);case 5:r=this.embedMetadata(n._attachments[n._id].dom,n.metadata),a=(new window.XMLSerializer).serializeToString(r).replace(/&lt;!\[CDATA\[/g,"<![CDATA[").replace(/]]&gt;/g,"]]>"),(i=document.createElement("a")).style="display:none",u=window.URL.createObjectURL(new window.Blob([a],{type:"image/svg+xml"})),i.href=u,i.download=t,document.body.appendChild(i),i.click(),window.URL.revokeObjectURL(u),i.parentNode.removeChild(i);case 16:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"matchDataPaths",value:function(e,t,n){if(!(n&&n.datasets&&e&&t))return!1;var r=i.query(n.datasets,e),a=i.query(n.datasets,t);return 1===r.length&&1===a.length&&r[0]===a[0]}},{key:"matchDomSelectors",value:function(e,t,n){return!(!e||!t)&&n.querySelector(e)===n.querySelector(t)}},{key:"getMatches",value:function(e,n){var r=this,a=[];return e&&e.bindings&&e.datasets&&n&&t.values(e.bindings).forEach(function(u){if(u.dataRoot&&u.svgRoot&&u.keyFunction&&u.keyFunction.dataExpression){var o=(0,eval)(u.keyFunction.dataExpression),s=i.query(e.datasets,u.dataRoot)[0],l=void 0;if(s instanceof Array)l=s.map(function(e,t){return{key:t,value:e}});else{if("object"!==(void 0===s?"undefined":c(s)))return;l=t.entries(s)}var d=n.querySelector(u.svgRoot),p=Array.from(d.children);l.forEach(function(e){var t=o(e.value,e.key);u.keyFunction.customMapping?a.push.apply(a,M(r.getManualConnections(u,t,e.value,p))):void 0!==u.keyFunction.svgExpression?a.push.apply(a,M(r.getExpressionConnections(u,t,e.value,p))):a.push.apply(a,M(r.getInferredConnections(u,t,e.value,p)))})}}),a}},{key:"getManualConnections",value:function(e,t,n,r){return[]}},{key:"getExpressionConnections",value:function(e,r,a,i){var u=(0,eval)(e.keyFunction.svgExpression),o=[];return i.forEach(function(e,i){u(e,i,t.select(e),n(e))===r&&o.push({dataItem:a,svgItem:e})}),o}},{key:"getInferredConnections",value:function(e,t,n,r){return[]}}]),o}(o.Model))});